name: iOS-ipa-build

on:
  push:
    branches:
      - main

jobs:
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    env:
      release:
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Get Version from Project File
        id: get-version
        run: echo "version=$(yq '.version' pubspec.yaml)" >> $GITHUB_OUTPUT
      - name: Get Current Version
        run: |
          echo "release=$(curl -qsSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${{ github.api_url }}/repos/${{ github.repository }}/releases/latest" \
          | jq -r .tag_name)" >> $GITHUB_ENV
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-latest
    needs: get-version
    outputs:
      ipa-size: ${{ steps.ipa-size.outputs.size }}
    steps:
      - uses: actions/checkout@v3

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
      - run: flutter pub get

      - run: pod repo update
        working-directory: ios

      - run: flutter build ios --release --no-codesign

      - run: mkdir Payload
        working-directory: build/ios/iphoneos

      - run: mv Runner.app/ Payload
        working-directory: build/ios/iphoneos

      - name: Zip output
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      - name: Get IPA size
        id: ipa-size
        run: |
          echo "size=$(stat -f%z build/ios/iphoneos/FlutterIpaExport.ipa)" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v${{ needs.get-version.outputs.version }}
          asset_name: InventoryCount.ipa
          overwrite: true
  update-app-description:
    name: Update app_description.json
    runs-on: ubuntu-latest
    needs: [get-version, build-ios]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Update app_description.json
        env:
          IPA_SIZE: ${{ needs.build-ios.outputs.ipa-size }}
        run: |
          sed -i "s/\"version\": \"0.6.2\"/\"version\": \"${{ needs.get-version.outputs.version }}\"/" ios/app_description.json
          sed -i "s/\"versionDate\": \"2025-07-01T01:20:17Z\"/\"versionDate\": \"$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)\"/" ios/app_description.json
          sed -i "s/\"size\": [0-9]\+/\"size\": $IPA_SIZE/" ios/app_description.json
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/v${{ needs.get-version.outputs.version }}/InventoryCount.ipa"
          sed -i "s#\"downloadURL\": \"[^\"]*\"#\"downloadURL\": \"$DOWNLOAD_URL\"#" ios/app_description.json

      - name: Add version to versions list
        env:
          IPA_SIZE: ${{ needs.build-ios.outputs.ipa-size }}
        run: |
          VERSION=$(yq '.version' pubspec.yaml)
          VERSION_DATE=$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)
          # Add or update versions list
          if grep -q '"versions"' ios/app_description.json; then
            jq \
              --arg v "$VERSION" \
              --arg d "$VERSION_DATE" \
              --argjson s "$IPA_SIZE" \
              --arg u "$DOWNLOAD_URL" \
              '(.versions // []) as $versions | .versions = (
                if ($versions | map(.version == $v) | any) then
                  ($versions | map(if .version == $v then .version = $v | .versionDate = $d | .size = $s | .downloadURL = $u else . end))
                else
                  ($versions + [{version: $v, versionDate: $d, size: $s, downloadURL: $u}])
                end
              )' \
              ios/app_description.json > ios/app_description.json.tmp && mv ios/app_description.json.tmp ios/app_description.json
          else
            jq \
              --arg v "$VERSION" \
              --arg d "$VERSION_DATE" \
              --argjson s "$IPA_SIZE" \
              --arg u "$DOWNLOAD_URL" \
              '. + {versions: [{version: $v, versionDate: $d, size: $s, downloadURL: $u}]}' \
              ios/app_description.json > ios/app_description.json.tmp && mv ios/app_description.json.tmp ios/app_description.json
          fi