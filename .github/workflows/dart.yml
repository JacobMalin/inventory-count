name: iOS-ipa-build

on:
  push:
    branches:
      - main

jobs:
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-latest
    outputs:
      ipa-size: ${{ steps.ipa-size.outputs.size }}
    steps:
      - uses: actions/checkout@v3

      # Cache Flutter pub packages
      - name: Cache Flutter pub packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
          key: pub-cache-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      # Cache CocoaPods
      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ios/Pods
            ios/Podfile.lock
          key: cocoapods-${{ runner.os }}-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            cocoapods-${{ runner.os }}-

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
      - run: flutter pub get

      - run: pod repo update
        working-directory: ios

      - run: flutter build ios --release --no-codesign

      - run: mkdir Payload
        working-directory: build/ios/iphoneos

      - run: mv Runner.app/ Payload
        working-directory: build/ios/iphoneos

      - name: Zip output
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      - name: Get IPA size
        id: ipa-size
        run: |
          echo "size=$(stat -f%z build/ios/iphoneos/FlutterIpaExport.ipa)" >> $GITHUB_OUTPUT
        shell: bash

      - name: Save IPA as artifact
        uses: actions/upload-artifact@v4
        with:
          name: FlutterIpaExport
          path: build/ios/iphoneos/FlutterIpaExport.ipa
  update-app-description:
    name: Update app_description.json
    runs-on: ubuntu-latest
    needs: build-ios
    outputs:
      version: ${{ steps.set-version-vars.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set version variables
        id: set-version-vars
        run: |
          VERSION=$(yq '.version' pubspec.yaml)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          VERSION_DATE=$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)
          echo "VERSION_DATE=$VERSION_DATE" >> $GITHUB_ENV
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/v$VERSION/InventoryCount.ipa"
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV

      - name: Update app_description.json
        env:
          IPA_SIZE: ${{ needs.build-ios.outputs.ipa-size }}
        run: |
          jq \
            --arg v "$VERSION" \
            --arg d "$VERSION_DATE" \
            --argjson s "$IPA_SIZE" \
            --arg u "$DOWNLOAD_URL" \
            '.apps[0].version = $v | .apps[0].versionDate = $d | .apps[0].size = $s | .apps[0].downloadURL = $u' \
            ios/app_description.json > ios/app_description.json.tmp && mv ios/app_description.json.tmp ios/app_description.json

      - name: Add version to app's versions list
        env:
          IPA_SIZE: ${{ needs.build-ios.outputs.ipa-size }}
        run: |
          # Update the versions array inside the first app object
          jq \
            --arg v "$VERSION" \
            --arg d "$VERSION_DATE" \
            --argjson s "$IPA_SIZE" \
            --arg u "$DOWNLOAD_URL" \
            '(.apps[0].versions // []) as $versions | .apps[0].versions = (
              if ($versions | map(.version == $v) | any) then
                ($versions | map(if .version == $v then .version = $v | .date = $d | .size = $s | .downloadURL = $u else . end))
              else
                ($versions + [{version: $v, date: $d, size: $s, downloadURL: $u}])
              end
            )' \
            ios/app_description.json > ios/app_description.json.tmp && mv ios/app_description.json.tmp ios/app_description.json
      
      - name: Commit and push updated app_description.json
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ios/app_description.json
          git commit -m "chore: update app_description.json [skip ci]" || echo "No changes to commit"
          git push
  upload-IPA-to-release:
    name: Upload IPA to GitHub Release
    runs-on: ubuntu-latest
    needs: [build-ios, update-app-description]
    steps:
      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: FlutterIpaExport
          path: .

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: FlutterIpaExport.ipa
          tag: v${{ needs.update-app-description.outputs.version }}
          asset_name: InventoryCount.ipa
          overwrite: true