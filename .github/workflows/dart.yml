name: build-ios-and-android

on:
  push:
    branches:
      - main

jobs:
  get-and-bump-version:
    name: Get and Bump Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Bump version if same as latest release
        id: get-version
        run: |
          CURRENT_VERSION=$(yq '.version' pubspec.yaml)
          echo "Current pubspec version: $CURRENT_VERSION"

          # Get latest release tag from GitHub API (strip a leading 'v' if present).
          LATEST_TAG=$(curl -s "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/latest" | jq -r '.tag_name // empty')
          LATEST_TAG=${LATEST_TAG#v}
          echo "Latest release tag: ${LATEST_TAG:-<none>}"

          SHOULD_BUMP=false
          if [ -z "$LATEST_TAG" ]; then
            echo "No latest release found; will bump version."
            SHOULD_BUMP=true
          elif [ "$LATEST_TAG" = "$CURRENT_VERSION" ]; then
            echo "Latest release matches current version; will bump version."
            SHOULD_BUMP=true
          else
            echo "Latest release ($LATEST_TAG) differs from current version ($CURRENT_VERSION); skipping bump."
            SHOULD_BUMP=false
          fi

          if [ "$SHOULD_BUMP" = true ]; then
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
            yq -i ".version = \"$NEW_VERSION\"" pubspec.yaml
            echo "Bumped version from $CURRENT_VERSION to $NEW_VERSION"
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

            # Commit and push the bumped pubspec
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git pull
            git add pubspec.yaml
            git commit -m "chore: bump version to $NEW_VERSION [skip ci]" || echo "No changes to commit"
            git push
          else
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          fi
  build-ios:
    name: ðŸŽ‰ iOS Build
    runs-on: macos-latest
    needs: get-and-bump-version
    outputs:
      ipa-size: ${{ steps.ipa-size.outputs.size }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Ensure up to date
        run: git pull

      # Cache Flutter pub packages
      - name: Cache Flutter pub packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
          key: pub-cache-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      # Cache CocoaPods
      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ios/Pods
            ios/Podfile.lock
          key: cocoapods-${{ runner.os }}-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            cocoapods-${{ runner.os }}-

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
      - run: flutter pub get

      - run: pod repo update
        working-directory: ios

      - run: flutter build ios --release --no-codesign

      - run: mkdir Payload
        working-directory: build/ios/iphoneos

      - run: mv Runner.app/ Payload
        working-directory: build/ios/iphoneos

      - name: Zip output
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      - name: Get IPA size
        id: ipa-size
        run: |
          echo "size=$(stat -f%z build/ios/iphoneos/FlutterIpaExport.ipa)" >> $GITHUB_OUTPUT
        shell: bash

      - name: Rename IPA
        run: |
          mkdir -p build/release
          mv build/ios/iphoneos/FlutterIpaExport.ipa build/release/InventoryCount.ipa

      - name: Save IPA as artifact
        uses: actions/upload-artifact@v4
        with:
          name: FlutterIpaExport
          path: build/release/InventoryCount.ipa
  update-app-description:
    name: Update app_description.json
    runs-on: ubuntu-latest
    needs: [build-ios, get-and-bump-version]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Set version variables
        id: set-version-vars
        run: |
          VERSION_DATE=$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)
          echo "VERSION_DATE=$VERSION_DATE" >> $GITHUB_ENV
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/v${{ needs.get-and-bump-version.outputs.version }}/InventoryCount.ipa"
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV

      - name: Update app_description.json
        env:
          IPA_SIZE: ${{ needs.build-ios.outputs.ipa-size }}
        run: |
          jq \
            --arg v "${{ needs.get-and-bump-version.outputs.version }}" \
            --arg d "$VERSION_DATE" \
            --argjson s "$IPA_SIZE" \
            --arg u "$DOWNLOAD_URL" \
            '.apps[0].version = $v | .apps[0].versionDate = $d | .apps[0].size = $s | .apps[0].downloadURL = $u' \
            ios/app_description.json > ios/app_description.json.tmp && mv ios/app_description.json.tmp ios/app_description.json

      - name: Add version to app's versions list
        env:
          IPA_SIZE: ${{ needs.build-ios.outputs.ipa-size }}
        run: |
          # Update the versions array inside the first app object
          jq \
            --arg v "${{ needs.get-and-bump-version.outputs.version }}" \
            --arg d "$VERSION_DATE" \
            --argjson s "$IPA_SIZE" \
            --arg u "$DOWNLOAD_URL" \
            '(.apps[0].versions // []) as $versions | .apps[0].versions = (
              if ($versions | map(.version == $v) | any) then
                ($versions | map(if .version == $v then .version = $v | .date = $d | .size = $s | .downloadURL = $u else . end))
              else
                ([{version: $v, date: $d, size: $s, downloadURL: $u}] + $versions)
              end
            )' \
            ios/app_description.json > ios/app_description.json.tmp && mv ios/app_description.json.tmp ios/app_description.json
      
      - name: Commit and push updated app_description.json
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git pull
          git add ios/app_description.json
          git commit -m "chore: update app_description.json [skip ci]" || echo "No changes to commit"
          git push
  build-android:
    name: ðŸ¤– Android Build
    runs-on: ubuntu-latest
    needs: get-and-bump-version
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Ensure up to date
        run: git pull

      # Cache Flutter pub packages
      - name: Cache Flutter pub packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
          key: pub-cache-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-
      
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64
      - run: flutter pub get

      - run: flutter build apk --release

      - name: Rename apk
        run: |
          mkdir -p build/release
          mv build/app/outputs/flutter-apk/app-release.apk build/release/InventoryCount.apk

      - name: Save apk as artifact
        uses: actions/upload-artifact@v4
        with:
          name: FlutterApkExport
          path: build/release/InventoryCount.apk
  upload-release:
    name: Upload Release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    steps:
      - uses: actions/upload-artifact@v4
        with:
          name: my-artifact
          path: |
            build/release/InventoryCount.ipa
            build/release/InventoryCount.apk
    
